# Description: GPU-accelerated primitives for video and image rendering
# URL:         https://github.com/haasn/libplacebo
# Depends on:  glslang libunwind py3-glad vulkan-loader

# Maintainer notes on dependencies:
#   glslang=enabled: glslang SPIR-V compiler, needs glslang (enabled)
#   vulkan=enabled: Vulkan-based renderer, needs vulkan (enabled)
#   libunwind: Print stack traces caused by runtime errors (enabled)
#   shaderc=disabled: libshaderc SPIR-V compiler, needs shaderc (disabled)
#   lcms=disabled: LittleCMS 2 support, needs lcms2 (disabled)
#   xxhash: Faster replacement for internal siphash (enabled if installed)

name=libplacebo
version=7.351.0
release=2
source="https://github.com/haasn/$name/archive/v$version/$name-$version.tar.gz
	libplacebo-7.349.0-glslang-1.3.296.patch
	no-vulkan-headers.patch"

build() {
	for p in libplacebo*.patch no-vulkan-headers.patch; do
		patch -d $name-$version -Np1 -i $SRC/${p}
	done

	meson setup build $name-$version \
		--prefix=/usr \
		--buildtype=plain \
		--wrap-mode=nodownload \
		-D b_lto=true \
		-D b_pie=true \
		-D d3d11=disabled \
		-D demos=false \
		-D glslang=enabled \
		-D lcms=disabled \
		-D shaderc=disabled \
		-D tests=false \
		-D vulkan=enabled \
		-D vulkan-registry=/usr/share/vulkan/registry/vk.xml

	ninja -C build -j ${JOBS:-1} -v
	DESTDIR=$PKG ninja -C build install
}
