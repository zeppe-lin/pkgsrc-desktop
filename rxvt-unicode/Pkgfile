# Description: Virtual terminal fork with unicode and xft support
# URL:         http://software.schmorp.de/pkg/rxvt-unicode.html
# Depends on:  libptytty perl xorg-libxft xorg-libxmu

name=rxvt-unicode
version=9.31
release=1
source="http://dist.schmorp.de/$name/Attic/$name-$version.tar.bz2
	24-bit-color.patch
	7-bit-queries.patch
	enable-wide-glyphs.patch
	improve-font-rendering.patch
	lines-rewrap.patch
	perl5.38.patch
	urxvtcd
	urxvtcd.1
	urxvtcd.desktop
	urxvt.desktop"

build() {
	# Patch to work with perl 5.38.0 for UTF-8.
	# https://www.mail-archive.com/rxvt-unicode@lists.schmorp.de/msg02243.html
	patch -d $name-$version -p1 -i $SRC/perl5.38.patch

	# Multiple-char sequence for 7-bit queries.
	# http://lists.schmorp.de/pipermail/rxvt-unicode/2023q1/002640.html
	patch -d $name-$version -p0 -i $SRC/7-bit-queries.patch

	# Prompt position (revert lines-rewrap update in screen.C to 9.30).
	# http://lists.schmorp.de/pipermail/rxvt-unicode/2023q2/002661.html
	# https://wiki.archlinux.org/title/Rxvt-unicode#Wrong_shell_prompt_placement_after_upgrading_to_9.31
	patch -d $name-$version -p0 -i $SRC/lines-rewrap.patch

	# https://aur.archlinux.org/packages/rxvt-unicode-cvs-patched-wideglyphs
	patch -d $name-$version -p0 -i $SRC/24-bit-color.patch

	# https://aur.archlinux.org/packages/rxvt-unicode-cvs-patched-wideglyphs
	patch -d $name-$version -p0 -i $SRC/enable-wide-glyphs.patch

	# https://aur.archlinux.org/packages/rxvt-unicode-cvs-patched-wideglyphs
	patch -d $name-$version -p0 -i $SRC/improve-font-rendering.patch

	mkdir build; cd build

	../$name-$version/configure             \
		--prefix=/usr                   \
		--disable-pixbuf                \
		--disable-startup-notification  \
		--disable-transparency          \
		--disable-xim                   \
		--enable-frills                 \
		--enable-256-color              \
		--enable-xft                    \
		--enable-font-styles            \
		--enable-unicode3               \
		--enable-combining              \
		--disable-fallback              \
		--enable-mousewheel             \
		--enable-perl                   \
		--enable-24-bit-color           \
		--enable-wide-glyphs            \

	make V=1

	mkdir -p $PKG/usr/share/terminfo
	make TERMINFO=$PKG/usr/share/terminfo DESTDIR=$PKG install

	install -m 0755 $SRC/urxvtcd   $PKG/usr/bin/urxvtcd
	install -m 0644 $SRC/urxvtcd.1 $PKG/usr/share/man/man1/urxvtcd.1

	install -m 0644 -Dt $PKG/usr/share/applications/ \
		$SRC/urxvtcd.desktop $SRC/urxvt.desktop
}
