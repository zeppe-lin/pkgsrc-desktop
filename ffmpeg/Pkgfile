# Description: Complete solution to record, convert and stream audio and video
# URL:         https://ffmpeg.org/
# Depends on:  alsa-lib dav1d fdk-aac gnutls gsm lame libass libtheora libva libvdpau opus x264 xorg-libxv

name=ffmpeg
version=7.1.3
release=1
source="https://ffmpeg.org/releases/$name-$version.tar.bz2
	gcc-14.patch
	ffmpeg.enabled
	ffmpeg.disabled
	ffmpeg-x264-10bit.sh
	ffmpeg-x264-10bit.1.scdoc"

build() {
	# Ensure LTO objects for optimal performance
	CFLAGS="$CFLAGS -ffat-lto-objects"
	CXXFLAGS="$CXXFLAGS -ffat-lto-objects"

	# Fix build under GCC 14 (remove when upstreamed)
	patch -d $name-$version -Np1 -i $SRC/gcc-14.patch

	mkdir build; cd build

	# NOTE: gnutls is required dependency
	# For OpenSSL fallback, add: --enable-openssl --enable-nonfree
	# Feature flags parsed from ffmpeg.{enabled,disabled}, see README.md
	../$name-$version/configure \
		--prefix=/usr \
		--disable-debug \
		--disable-doc \
		--disable-stripping \
		--enable-avfilter \
		--enable-gpl \
		--enable-lto \
		--enable-pic \
		--enable-postproc \
		--enable-pthreads \
		--enable-shared \
		--enable-swresample \
		--enable-version3 \
		$(awk -F: '!/^($|#)/ && !system("pkgman isinst -- " $1 \
		" >/dev/null 2>&1") { print $2 }' $SRC/ffmpeg.enabled) \
		$(awk -F: '!/^($|#)/ { print $2 }' $SRC/ffmpeg.disabled)

	make V=1
	make DESTDIR=$PKG install install-man

	# Install optional x264 10-bit wrapper
	if pkgman isinst x264 >/dev/null 2>&1; then
		install -m 0755 -D $SRC/ffmpeg-x264-10bit.sh \
			$PKG/usr/bin/ffmpeg-x264-10bit
		scdoc < $SRC/ffmpeg-x264-10bit.1.scdoc > \
			$PKG/usr/share/man/man1/ffmpeg-x264-10bit.1
	fi

	# Remove bundled examples
	rm -r $PKG/usr/share/ffmpeg/examples
}
