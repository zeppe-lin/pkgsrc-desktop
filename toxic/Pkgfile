# Description: CLI Tox client
# URL:         https://github.com/JFreegman/toxic
# Depends on:  curl libconfig toxcore xorg-libx11

# Maintainer notes on dependencies:
#   DISABLE_QRCODE/QRPNG or needs qrencode (disabled)
#   DISABLE_DESKTOP_NOTIFY or needs libnotify/dbus (disabled)
#   DISABLE_AV/VI or needs libvpx/opus: Audio/Video (disabled)

name=toxic
version=0.16.1
release=1
source="https://github.com/JFreegman/$name/archive/v$version/$name-$version.tar.gz
	build-stable-c-toxcore.patch
	no-extra-flags.patch
	no-install-rebuild.patch"

build() {
	cd $name-$version

	# Preserve user CFLAGS/LDFLAGS
	export USER_CFLAGS="$CFLAGS"
	export USER_LDFLAGS="$LDFLAGS -pthread"

	patch -Np1 -i $SRC/build-stable-c-toxcore.patch
	patch -Np1 -i $SRC/no-extra-flags.patch
	patch -Np1 -i $SRC/no-install-rebuild.patch

	# Use /usr instead of /usr/local and clean up compiler calls
	sed -i 's|/usr/local|/usr|g' cfg/global_vars.mk
	sed -i 's|@$(CC) |$(CC) |g'  Makefile

	# Disable optional features:
	export DISABLE_GAMES=1           # games
	export DISABLE_QRCODE=1          # QR code, needs qrencode
	export DISABLE_QRPNG=1           # QR code, needs qrencode
	export DISABLE_DESKTOP_NOTIFY=1  # notifications, needs libnotify/dbus
	export DISABLE_AV=1              # audio
	export DISABLE_SOUND_NOTIFY=1    # sound notifications
	export DISABLE_VI=1              # video

	make PREFIX=/usr
	make DESTDIR=$PKG install

	# Remove junk
	#rm -f $PKG/usr/share/toxic/toxic.conf.example
	#rm -rf $PKG/usr/share/toxic/sounds
	#rm -rf $PKG/usr/share/applications
}
